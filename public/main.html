<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="./styles/styles.css">
    <link rel="stylesheet" href="./styles/main-style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <title>Home Page</title>
</head>
<body>
    <div class="nav-wrapper header">
        <a href="#!" class="center brand-logo logo"><img src="images/logo_white.png"></a>
        <a href="index.html" class="waves-effect waves-light btn-large" id="logout">Logout</a>
    </div>
    <ul id="tabs-swipe-demo" class="tabs">
        <li class="tab col s4" ><a class="active" href="#home">Home</a></li>
        <li class="tab col s4" ><a href="#deposit">Deposit</a></li>
        <li class="tab col s4" ><a href="#withdrawal">Withdrawal</a></li>
    </ul>
    <div id="home" class="col s12">
     
        <h3 id="welcome">Welcome, firstname lastname</h3>
      <hr class="horizontal"><h3 id="account">Account Summary</h3>
          <div class="account-main" style="border: solid 1px green">
        
        <div class ="account-summary" style="border: solid 1px green"><strong>  
          Account balance</strong>
        </div>
        <div class="netBalance" style="border: solid 1px green"><strong>  
            Net Balance</strong>
        </div>
      </div>    
      <hr class="horizontal">
        <h3 class="transaction">Transaction History</h3>
        <div class="transaction-history">
            Insert transaction history here
            <table>
              <tr>
                <th>Date</th>
                <th>Transactions</th> 
                <th>Amount</th>
              </tr>
              <tbody id="transactions"></tbody>
            </table>
        </div>
          <hr>
      <div id="chartDiv"><h4>See how are you spending compared to all our user</h4>
            <br>
        <div id="pie-my"><strong> My Expenses</strong>
          <canvas id="myChart" width="400" height="400"></canvas>
        </div>
        <div id="pie-other"> <strong> Other Expenses</strong>
          <canvas id="otherChart" width="400" height="400"></canvas>
        </div>
      </div>  
    </div>
    <div id="deposit" class="col s12">
        <div class="row">
            <h1 id="deposit-title">Deposit</h1>
            <form class="col s12">
                <div class="row">
                <div class="input-field col s12">
                    <input placeholder="$1,000,000" id="deposit-amount" type="text">
                    <label for="deposit-amount">How much do you want to deposit?</label>
                </div>
                </div>
                <div class="row">
                <div class="input-field col s12">
                    <input id="deposit-email" type="email" class="validate">
                    <label for="deposit-email">Please enter your email for receipt.</label>
                </div>
                </div>
                <button class="btn waves-effect waves-light" type="submit" name="action">Submit</button>
            </form>
        </div>
    </div>
    <div id="withdrawal" class="col s12">
        <h1 id="withdrawal-title">Withdrawal</h1>
        <div class="row">
            <form class="col s12">
                <div class="row">
                <div class="input-field col s12">
                    <input placeholder="$1,000,000" id="withdrawal-amount" type="text">
                    <label for="withdrawal-amount">How much do you want to Withdraw?</label>
                </div>
                </div>
                <div class="row">
                <div class="input-field col s12">
                    <input id="withdrawal-email" type="email" class="validate">
                    <label for="withdrawal-email">Please enter your email for receipt.</label>
                </div>
                </div>
                <button class="btn waves-effect waves-light" type="submit" name="action">Submit</button>
            </form>
        </div>
    </div>

    <div class="footer">
        
    </div>
    <footer class="page-footer grey">
        <div class="container">
            <div class="row">
            <div class="col l6 s12">
                <h5 class="white-text">University Bootcamp Bank</h5>
                <p class="grey-text text-lighten-4">University Bootcamp bank is dedicated to providing the best banking experience. Lightening Fast Withdrawals and Deposits are available 100% online. Use our Budgeting App to track how you are spending monthly.</p>
            </div>
            
            <div class="col l6 s12">
                <h5 class="white-text">Our Services</h5>
                <ul>
                    <li>Instant Withdrawals</li>
                    <li>Instant Deposits</li>
                    <li>Check your Balance and Transaction History</li>
                    <li>Monthly Budget Charts</li>
                </ul>
            </div>
            </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
            Made by Jimin Huh, Daniel Barkley, Nitesh Desai, Colin Lawerence, Diwal Pyakurel.
            </div>
        </div>
    </footer>



    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <script>
      var elem = document.querySelector(".tabs");
      var instance = M.Tabs.init(elem, {});

      var balance = 0;
      var deposit = 0;
      var withdrawl = 0;
      var pendingCredit=0;
      var pendingDebit=0;
      var allTransactions;
      var id = localStorage.getItem("username");
      //var id = "Diwal";

      $("#welcome").text("Welcome "+ id)
      

      $.get("/api/transactions/" + id, function(data) {
        console.log("working");
        console.log(data[0]);
        for (var i = 0; i < data.length; i++) {
          if (data[i].type === "Withdrawl") {
            balance = balance - data[i].amount;
          } else {
            balance = balance + data[i].amount;
          }
        }
        console.log(balance);
        allTransactions=data;
      }).then(function() {
        var curentBalanceRow =
          "<tr><td>Available Balance</td><td>" + balance + "</td></tr>";
        $(".account-summary").append(curentBalanceRow);
        
        for(var i=0; i<allTransactions.length; i++){
        var transactionsRow = "<tr><td>"+ allTransactions[i].createdAt.substring(0,10)+"</td><td>"+allTransactions[i].type +"</td><td>"+allTransactions[i].amount +"</td></tr>";
        $("#transactions").append(transactionsRow);
        }

      });




      $.get("/api/transaction-deposit/" + id, function(data) {
        console.log("deposit data");
        console.log(data[data.length-1]);

        for(var i =0; i<data.length; i++){
          deposit = deposit + data[i].amount;
        }
        console.log(deposit);
        if(data.length>=1){
        pendingCredit = data[data.length-1].amount;
        }

      }).then(function() {
          var pendingCreditRow =
          "<tr><td>Pending Credit</td><td>" + pendingCredit + "</td></tr>";
        $(".account-summary").append(pendingCreditRow);

          var withdrawlRow =
          "<tr><td>Deposit</td><td>" +deposit + "</td></tr>";
        $(".netBalance").append(withdrawlRow);
       
      });




      $.get("/api/transaction-withdrawl/" + id, function(data) {
     

        for(var i =0; i<data.length; i++){
          withdrawl = withdrawl + data[i].amount;
        }
        console.log(deposit);

        if(data.length>=1){
        pendingDebit = data[data.length-1].amount;
        }

      }).then(function() {
          var pendingDebitRow =
          "<tr><td>Pending Debit</td><td>" + pendingDebit + "</td></tr>";
        $(".account-summary").append(pendingDebitRow);


        var withdrawlRow =
          "<tr><td>Withdrawl</td><td>" + withdrawl + "</td></tr>";
        $(".netBalance").append(withdrawlRow);
    
      });



      $("#deposit").on("click", function(e) {
        e.preventDefault();
        console.log("deposit buton is working");

        var deposit = {
          user_ID: localStorage.getItem("username"),
          type: "deposit",
          amount: $("#deposit-amount")
            .val()
            .trim(),
          categories: ""
        };

        $.ajax("/api/transactions", {
          type: "POST",
          data: deposit
        }).then(function() {
          console.log("new deposit transaction added");
          location.reload();
        });
      });



      $("#withdrawal").on("click", function(e) {
       e.preventDefault();
       console.log("withdraw button is working");

       var withdrawl = {
         user_ID: localStorage.getItem("username"),
         type: "Withdrawal",
         amount: $("#withdrawal-amount")
           .val()
           .trim(),
         categories: ""
       };

       $.ajax("/api/transactions", {
         type: "POST",
         data: withdrawl
       }).then(function() {
         console.log("new withdrawal added");
         location.reload();
       });
     });


    



  // select categories, sum(amount) from transactions where user_ID = "Diwal" and type="Withdrawl" group by categories;

      $.get("/api/budget/"+ id, function(data) {
        var categories = [];
        var values = [];
        for (var i= 0; i<data.length; i++){
           categories.push(data[i].categories);
          values.push(data[i].amount)
        }
        createChart("myChart","pie", categories, values);

      });

      $.get("/api/budget-other", function(data) {
        var categories = [];
        var values = [];
        for (var i= 0; i<data.length; i++){
           categories.push(data[i].categories);
          values.push(data[i].amount)
        }
        createChart("otherChart","pie", categories, values);

      });


      function createChart (chartID, chartType, lablesInput, valuesInput){
        var ctx = document.getElementById(chartID).getContext('2d');
var myChart = new Chart(ctx, {
    type: chartType,
    data: {
        labels: lablesInput,
        datasets: [{
            label: 'Budget',
            data: valuesInput,
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
        }
    }
});

      }



    </script>
  </body>
</html>
